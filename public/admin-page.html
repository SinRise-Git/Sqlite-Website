<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>
    <link rel="stylesheet" href="./css/style.css">
</head>
<body>
    <h2>Admin page</h2>
    <div class="main">
        <div class="showUsers">
            <h2>Show Users</h2>
            <table id="usersTable">
                <div class="filters">
                    <label for="filterRole">Filter Role:</label>
                    <select name="filterRole" id="filterRole" onchange="getUserAdmin()">
                        <option value="All">All</option>
                        <option value="Tamburmajor">Tamburmajor</option>
                        <option value="Trommeslager">Trommeslager</option>
                        <option value="Korpsfanebærer">Korpsfanebærer </option>
                        <option value="Korpssjef">Korpssjef</option>
                        <option value="Medlemmer">Medlemmer</option>
                    </select>
                    <label for="filterKompani">Filter Kompani:</label>
                    <select name="filterKompani" id="filterKompani" onchange="getUserAdmin()">
                        <option value="All">All</option>
                    </select>
                    <label for="filterUserstatus">Filter Userstatus:</label>
                    <select name="filterUserstatus" id="filterUserstatus" onchange="getUserAdmin()">
                        <option value="All">All</option>
                        <option value="True">True</option>
                        <option value="False">False</option>
                    </select>
                    <label for="filterUsertype">Filter Usertype:</label>
                    <select name="filterUsertype" id="filterUsertype" onchange="getUserAdmin()">
                        <option value="All">All</option>
                        <option value="Medlem">Medlem</option>
                        <option value="Medlem">Foreldre</option>
                        <option value="Leder">Leder</option>
                    </select>  
                </div>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Telephone</th>
                        <th>Gender</th>
                        <th>User Type</th>
                        <th>Role</th>
                        <th>Kompani</th>
                        <th>User Status</th>
                    </tr>
                </thead>
            </table>
        </div>
        <div class="addKompani">
             <h3>Add Kompani</h3>
            <form >
                <label for="addKompanis">Name:</label>
                <input id="addKompanis" type="text" name="addKompanis" required>
            </form>
            <br>
            <button id="addKompaniButton">Add Kompani</button>
            <table id="kompaniTable">
                <thead>
                    <tr>
                        <th>Name</th>
                    </tr>
                </thead>
            </table>
        </div>
        <button onclick="checkLoginAdmin()">Check Session</button>
    </div>
    <script>
        async function checkLoginAdmin(){
           let response = await fetch('/checkLoginAdmin')
        }
        document.getElementById('addKompaniButton').addEventListener('click', async function(event) {
            event.preventDefault();
            const creatKompani = {
                newKompani: document.getElementById('addKompanis').value
            };

            const requestOptions = {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify(creatKompani)
            };
           
            const response = await fetch('/createKompani', requestOptions);
            const data = await response.json();
        })    

        async function getUserAdmin() {
            let selectedRole = document.getElementById("filterRole").value;
            let selectedKompani = document.getElementById("filterKompani").value;
            let selectedUserstatus = document.getElementById("filterUserstatus").value;
            let selectedUsertype = document.getElementById("filterUsertype").value;

            let response = await fetch('/getUsersAdmin')
            let users = await response.json()
            let usersTable = document.getElementById("usersTable")

            while (usersTable.rows.length > 1) {
                usersTable.deleteRow(1);
            }

            users.forEach(user => {
                if ((selectedRole === "All" || user.role === selectedRole) &&
                    (selectedKompani === "All" || user.kompani === selectedKompani) && 
                    (selectedUserstatus === "All" || user.userstatus === selectedUserstatus) &&
                    (selectedUsertype === "All" || user.userType === selectedUsertype) 
                    ){
                    let row = usersTable.insertRow();
                    row.insertCell().textContent = user.name;
                    row.insertCell().textContent = user.telephone;
                    row.insertCell().textContent = user.gender;
                    row.insertCell().textContent = user.userType;
                    row.insertCell().textContent = user.role;
                    row.insertCell().textContent = user.kompani;
                    row.insertCell().textContent = user.userstatus;
                    let activateButton = document.createElement("button");
                    activateButton.id = "activateButton"
                    activateButton.textContent = "Activate";
                    activateButton.value = user.name;
                    row.insertCell().appendChild(activateButton);
                    let deleteButton = document.createElement("button");
                    deleteButton.id = "deleteButton"
                    deleteButton.textContent = "Delete";
                    deleteButton.value = user.name;
                    row.insertCell().appendChild(deleteButton);
                    deleteButton.addEventListener('click', showDelete(user.name))
                    activateButton.addEventListener('click', showActivate(user.name))
                }
            });
        }
        function showDelete(userName) {
            return async function(event) {
               event.preventDefault();
               const deleteUser = {
                 name: userName
                };

                const requestOptions = {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(deleteUser)
                };
                 const response = await fetch('/deleteUser', requestOptions);
                 const data = await response.json();
            }
        };
        
        function showActivate(userName) {
            return async function(event) {
               event.preventDefault();
               const activateUser = {
                 name: userName
                };

                const requestOptions = {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(activateUser)
                };
                 const response = await fetch('/activateUser', requestOptions);
                 const data = await response.json();
            }
        };
        async function getKompani(){
            let response = await fetch('/getKompani')
            let kompanis = await response.json()
            let usersTable = document.getElementById("kompaniTable")
            kompanis.forEach(kompani => {
              let row = usersTable.insertRow()
              row.insertCell().textContent = kompani.kompani;
              let deleteButton = document.createElement("button");
              deleteButton.id = "deleteButtonKompani"
              deleteButton.textContent = "Delete";
              deleteButton.value = kompani.kompani;
              row.insertCell().appendChild(deleteButton);

              deleteButton.addEventListener('click', kompaniDelete(kompani.kompani))
            
            });
        }
        function kompaniDelete(kompani) {
            return async function(event) {
               event.preventDefault();
               const deleteKompani = {
                 kompani: kompani
                };

                const requestOptions = {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(deleteKompani)
                };
                 const response = await fetch('/deleteKompani', requestOptions);
                 const data = await response.json();
            }
        };
        async function getKompaniFiler(){
            let response = await fetch('/getKompani')
            let kompanis = await response.json()
            let kompaniTable = document.getElementById("filterKompani");
            kompanis.forEach(kompani => {
                let option = document.createElement("option");
                option.value = kompani.kompani;
                option.textContent = kompani.kompani;
                kompaniTable.appendChild(option);
            });
        }
        getKompaniFiler()
        getKompani()
        getUserAdmin()
    </script>
</body>
</html>
